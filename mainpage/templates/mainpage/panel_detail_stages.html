
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
{% load staticfiles %}
 <link href="{% static 'css/terminal_textarea.css' %}" rel="stylesheet">

<div class="row col-lg-12">
    <div class='col-xs-5' id="to-do">
        <h3 class="page-header"> Stages </h3>
        <form id="form_upload" method="post" action="{% url 'upload' project_object.projectId %}"
              enctype="multipart/form-data" class="form-inline">
        <div class="form-inline" style="padding-bottom: 20px">
            <label> Testing Stage </label>
            <div class="pull-right">
                <input name="my_file" multiple class="form-control" type="file" id ="input">
            </div>
        </div>
        <div class="form-inline" style="padding-bottom: 20px">
            <label> Test failure Stage </label>
            <div class="pull-right">
                <input multiple class="form-control " type="file" id ="input1">
            </div>
        </div>
        <div class="form-inline">
            <label> Deploy Stage </label>
            <div class="pull-right">
                <input multiple class="form-control " type="file" id ="input2">
            </div>
        </div>



            <button style="display:none;" id="btn_upload" class="btn btn-success" type="submit">upload</button>
        </form>
    </div>
    <div class='col-xs-5'>
        <div class="shell-wrap">
           <!--<p class="shell-top-bar"><Strong>.gitlab-ci.yml Preview</Strong></p>-->
          <ul class="shell-body">
              <li><strong>test:</strong>
                <ul id="list" class="shell-body">

                </ul>
              </li>
            <li><strong>test_failure:</strong>
                <ul id="list1" class="shell-body">
                </ul>
            </li>
            <li><strong>deploy:</strong>
                <ul id="list2" class="shell-body">
                </ul>
            </li>
            <li>
                <div class="a_tag">
               <a class="a_tag" style="font-size:14pt;" href="javascript:;" onclick="$('#btn_upload').click();">
                    <strong style="float:right;"> Upload </strong></a>
                </div>
            </li>
          </ul>
          <ul class="shell-body">
          </ul>
            <ul class="shell-body">
          </ul>
        </div>

    </div>
</div>


<div class="row col-lg-10">
     <h3 class="page-header"> </h3>
    <div class="alert">
        <div class="text-right">
            <button id='run_job' data-toggle="modal" data-target="#myModal"
                    type="button" class="btn btn-success">Start the CI job!</button>
        </div>

        <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog">

          <!-- Modal content-->
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal">&times;</button>

              <h4 class="modal-title">Running Job</h4>
            </div>
                <div class="modal-body">
                  {% load static %}
                    <span style="text-align:center" id="loading_img"><img src="{% static 'img/loading_small.gif' %}">
                        <h3 style="display:inline-block" id="job_status">preparing</h3></span>
                  <h3 id="job_result"></h3>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
              </div>

            </div>
        </div>
    </div>
</div>

<script>
    $(function() {
        var run_job_validator = false;
        // data
        yml_data = {'test':{}, 'failure':{}, 'deploy':{}};
        // button
        $('#input').on('change', function(){add_to_list('#input','#list')});
        $('#input1').on('change', function(){add_to_list('#input1', '#list1')});
        $('#input2').on('change', function(){add_to_list('#input2', '#list2')});

        // list container

        // override submit

         $('#form_upload').submit(function(e){
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: $(this).attr('action'),
                data: new FormData($(this)[0]),
                success: function(data){
                    alert('haha');
                    $.ajax({
                        type: "POST",
                        url: 'yml_process/',
                        data: JSON.stringify(yml_data),
                        dataType: 'json',
                        success: get_data,

                    });

                },
                cache: false,
                contentType: false,
                processData: false
            });

         });




        function add_to_list(input_id, list_id){
            var listContainer = $(list_id);

            // value of input
            //var ary = $(input_id).val().split('\\');
            var files = $(input_id).prop('files');
            var fname_list = $.map(files, function(val){return val.name;});


            // add new list item
            if(fname_list.length > 0){
                $.each(fname_list, function(i, fname){
                    if(fname.includes("test_")){
                        fname = "- pytest " + fname;
                    }else{
                        fname = "- python " + fname;
                    }
                    if($(input_id).attr('id')== "input"){
                        if(!('script' in yml_data['test'])){
                            yml_data['test']['script'] = []
                        }
                        yml_data['test']['script'].push(fname);
                        run_job_validator = true;
                    }else if($(input_id).attr('id') == "input1"){
                        if(!('script' in yml_data['failure'])){
                            yml_data['failure']['script'] = []
                        }
                        yml_data['failure']['script'].push(fname);
                        run_job_validator = true;
                    }else{
                        if(!('script' in yml_data['deploy'])){
                            yml_data['deploy']['script'] = []
                        }
                        yml_data['deploy']['script'].push(fname);
                        run_job_validator = true;
                    }
                    // alert(JSON.stringify(yml_data));
                    listContainer.append('<li> ' + fname + '</li>');
                    // clear value input
                });
            }
        }

        function get_data(){
            var interval_id = setInterval(
                function(){
                    $.ajax({
                        type: "GET",
                        url: 'yml_process/',
                        dataType: 'json',
                        success: function(data){

                            var json_verify = false;
                            try{
                                ('id' in data);
                                json_verify = true;
                            }catch(e){
                                json_verify = false;
                            }

                            if(!json_verify){
                                clearInterval(interval_id);
                                $("#loading_img").hide();
                                $("#job_result").html(data);
                            }else{

                                if(data['status'] == 'failed' ||data['status'] == 'success'){

                                    clearInterval(interval_id);
                                    $("#loading_img").hide();
                                    $("#job_status").html('preparing');
                                    $("#job_result").html(data['status'] + data['id']);
                                }else{
                                    $("#job_status").html(data['status']);
                                }
                            }
                        }
                    });
                }
            , 2000);
        }

        $("#run_job").on('click', function(){
            $("#loading_img").show();
            $("#job_result").html('');
            if(run_job_validator){

                $(this).attr('data-toggle', 'modal');
                $('#btn_upload').click();
            }else{
                $(this).attr('data-toggle', '');
                alert("No job to run!");
            }
        });
    });
</script>